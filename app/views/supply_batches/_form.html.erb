<%= turbo_frame_tag "modal" do %>
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
       data-controller="modal"
       data-action="click->modal#close">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto"
         data-modal-target="content"
         data-action="click->modal#preventClose">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">
            <%= supply_batch.new_record? ? "Novo Lote" : "Editar Lote" %>
          </h2>
          <%= link_to "×", supply_batches_path,
                      class: "text-gray-500 hover:text-gray-700 text-3xl font-bold",
                      data: { turbo_frame: "_top" } %>
        </div>

        <%= turbo_frame_tag "supply_batch_form" do %>
          <%= form_with model: supply_batch,
                        id: "supply_batch_form",
                        data: { controller: "date-input" } do |f| %>
            
            <% if supply_batch.errors.any? %>
              <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-4">
                <h3 class="text-red-800 font-semibold mb-2">
                  <%= pluralize(supply_batch.errors.count, "erro") %> encontrado(s):
                </h3>
                <ul class="list-disc list-inside text-red-700 text-sm">
                  <% supply_batch.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <div class="space-y-4">
              <!-- Food Item -->
              <div>
                <%= f.label :food_item_id, "Alimento *", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.select :food_item_id,
                            options_for_select(
                              @food_items.map { |fi| [fi.name, fi.id] },
                              supply_batch.food_item_id
                            ),
                            { prompt: "Selecione um alimento" },
                            class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                            required: true %>
              </div>

              <!-- Quantidades -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <%= f.label :initial_quantity, "Quantidade Inicial *", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= f.number_field :initial_quantity,
                                    step: 0.01,
                                    min: 0.01,
                                    class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                                    required: true %>
                </div>

                <div>
                  <%= f.label :current_quantity, "Quantidade Atual", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= f.number_field :current_quantity,
                                    step: 0.01,
                                    min: 0,
                                    class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                                    placeholder: "Será preenchido automaticamente" %>
                </div>
              </div>

              <!-- Datas -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <%= f.label :entry_date, "Data de Entrada *", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= f.date_field :entry_date,
                                  class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                                  required: true,
                                  data: { date_input_target: "field" } %>
                </div>

                <div>
                  <%= f.label :expiration_date, "Data de Validade", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= f.date_field :expiration_date,
                                  class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                                  data: { date_input_target: "field" } %>
                </div>
              </div>

              <!-- Código do Lote e Fornecedor -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <%= f.label :batch_code, "Código do Lote", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= f.text_field :batch_code,
                                  class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                                  placeholder: "Ex: LOTE-2024-001" %>
                </div>

                <div>
                  <%= f.label :supplier, "Fornecedor", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= f.text_field :supplier,
                                  class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                                  placeholder: "Nome do fornecedor" %>
                </div>
              </div>

              <!-- Custo Unitário -->
              <div>
                <%= f.label :unit_cost, "Custo Unitário (R$)", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.number_field :unit_cost,
                                  step: 0.01,
                                  min: 0,
                                  class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                                  placeholder: "0.00" %>
              </div>

              <!-- Status (apenas para edição) -->
              <% unless supply_batch.new_record? %>
                <div>
                  <%= f.label :status, "Status", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= f.select :status,
                              [
                                ["Ativo", "active"],
                                ["Esgotado", "depleted"],
                                ["Vencido", "expired"]
                              ],
                              {},
                              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
                </div>
              <% end %>

              <!-- Observações -->
              <div>
                <%= f.label :notes, "Observações", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.text_area :notes,
                               rows: 3,
                               class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                               placeholder: "Informações adicionais sobre o lote..." %>
              </div>
            </div>

            <div class="flex gap-3 mt-6">
              <%= f.submit supply_batch.new_record? ? "Criar Lote" : "Atualizar Lote",
                          class: "flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition" %>
              <%= link_to "Cancelar", supply_batches_path,
                          class: "flex-1 text-center bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded transition",
                          data: { turbo_frame: "_top" } %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

