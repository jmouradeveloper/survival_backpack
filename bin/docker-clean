#!/usr/bin/env bash
# Script para limpar containers e volumes Docker

set -e

echo "üßπ Limpando ambiente Docker do Survival Backpack..."

# Verificar se docker-compose est√° instalado
if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker n√£o est√° instalado."
    exit 1
fi

# Confirmar a√ß√£o
read -p "‚ö†Ô∏è  Isso ir√° remover todos os containers, volumes e dados. Continuar? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå Opera√ß√£o cancelada."
    exit 1
fi

# Parar e remover containers
echo "üõë Parando containers..."
if docker compose version &> /dev/null; then
    docker compose down
else
    docker-compose down
fi

# Remover volumes
echo "üóëÔ∏è  Removendo volumes..."
if docker compose version &> /dev/null; then
    docker compose down -v
else
    docker-compose down -v
fi

# Remover imagens relacionadas (opcional)
read -p "Deseja remover tamb√©m as imagens Docker? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üóëÔ∏è  Removendo imagens..."
    if docker compose version &> /dev/null; then
        docker compose down -v --rmi all
    else
        docker-compose down -v --rmi all
    fi
fi

# Limpar arquivos tempor√°rios locais (opcional)
read -p "Deseja limpar tamb√©m os arquivos tempor√°rios locais (log, tmp)? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üóëÔ∏è  Limpando arquivos tempor√°rios..."
    
    # Tentar remover normalmente
    echo "Removendo arquivos com permiss√µes normais..."
    find log -type f -delete 2>/dev/null || true
    find tmp -type f -delete 2>/dev/null || true
    find log -type d -empty -delete 2>/dev/null || true
    find tmp -type d -empty -delete 2>/dev/null || true
    
    # Verificar se ainda h√° arquivos (que precisam de sudo)
    if [ -n "$(find log tmp -type f 2>/dev/null)" ]; then
        echo ""
        echo "‚ö†Ô∏è  Alguns arquivos foram criados pelo Docker e precisam de permiss√µes elevadas."
        read -p "Deseja usar sudo para remover esses arquivos? (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "üîê Usando sudo para remover arquivos restantes..."
            sudo find log -type f -delete 2>/dev/null || true
            sudo find tmp -type f -delete 2>/dev/null || true
            sudo find log -type d -empty -delete 2>/dev/null || true
            sudo find tmp -type d -empty -delete 2>/dev/null || true
            echo "‚úÖ Arquivos removidos com sucesso!"
        else
            echo "‚ö†Ô∏è  Alguns arquivos permaneceram. Execute manualmente: sudo rm -rf log/* tmp/*"
        fi
    else
        echo "‚úÖ Arquivos tempor√°rios removidos com sucesso!"
    fi
fi

echo ""
echo "‚úÖ Limpeza conclu√≠da!"
echo ""
echo "Para reconfigurar o ambiente: bin/docker-setup"

