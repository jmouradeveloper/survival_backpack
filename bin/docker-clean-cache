#!/usr/bin/env bash
# Script para limpar cache e arquivos temporÃ¡rios usando o container Docker
# Ãštil para limpar arquivos criados pelo container sem problemas de permissÃ£o

set -e

echo "ðŸ§¹ Limpando cache da aplicaÃ§Ã£o via Docker..."

# Verificar se docker estÃ¡ instalado
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker nÃ£o estÃ¡ instalado."
    exit 1
fi

# Verificar se o container estÃ¡ rodando
CONTAINER_NAME="survival_backpack_web"
if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "âš ï¸  Container ${CONTAINER_NAME} nÃ£o estÃ¡ rodando."
    echo "Iniciando container temporariamente para limpeza..."
    
    # Iniciar container temporÃ¡rio
    if docker compose version &> /dev/null; then
        docker compose up -d
    else
        docker-compose up -d
    fi
    
    TEMP_START=true
    sleep 3
fi

echo "ðŸ—‘ï¸  Limpando tmp/cache/..."
if docker compose version &> /dev/null; then
    docker compose exec web rm -rf tmp/cache/*
else
    docker-compose exec web rm -rf tmp/cache/*
fi

echo "ðŸ—‘ï¸  Limpando log/*.log..."
if docker compose version &> /dev/null; then
    docker compose exec web sh -c "find log -name '*.log' -type f -exec truncate -s 0 {} \;"
else
    docker-compose exec web sh -c "find log -name '*.log' -type f -exec truncate -s 0 {} \;"
fi

# Parar container se foi iniciado temporariamente
if [ "${TEMP_START}" = "true" ]; then
    echo "ðŸ›‘ Parando container temporÃ¡rio..."
    if docker compose version &> /dev/null; then
        docker compose stop
    else
        docker-compose stop
    fi
fi

echo ""
echo "âœ… Limpeza de cache concluÃ­da!"
echo ""
echo "Cache e logs foram limpos dentro do container Docker."

