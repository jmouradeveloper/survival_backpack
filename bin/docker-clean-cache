#!/usr/bin/env bash
# Script para limpar cache e arquivos tempor√°rios usando o container Docker
# √ötil para limpar arquivos criados pelo container sem problemas de permiss√£o

set -e

echo "üßπ Limpando cache da aplica√ß√£o via Docker..."

# Verificar se docker est√° instalado
if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker n√£o est√° instalado."
    exit 1
fi

# Verificar se o container est√° rodando
CONTAINER_NAME="survival_backpack_web"
if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "‚ö†Ô∏è  Container ${CONTAINER_NAME} n√£o est√° rodando."
    echo "Iniciando container temporariamente para limpeza..."
    
    # Iniciar container tempor√°rio
    docker compose up -d
    
    TEMP_START=true
    sleep 3
fi

echo "üóëÔ∏è  Limpando tmp/cache/..."
docker compose exec web rm -rf tmp/cache/*

echo "üóëÔ∏è  Limpando log/*.log..."
docker compose exec web sh -c "find log -name '*.log' -type f -exec truncate -s 0 {} \;"

# Parar container se foi iniciado temporariamente
if [ "${TEMP_START}" = "true" ]; then
    echo "üõë Parando container tempor√°rio..."
    docker compose stop
fi

echo ""
echo "‚úÖ Limpeza de cache conclu√≠da!"
echo ""
echo "Cache e logs foram limpos dentro do container Docker."

