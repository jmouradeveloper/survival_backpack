#!/usr/bin/env bash
# Script para acompanhar logs dos serviÃ§os Docker

set -e

# Verificar se docker estÃ¡ instalado
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker nÃ£o estÃ¡ instalado."
    exit 1
fi

# Verificar se o container estÃ¡ rodando
CONTAINER_NAME="survival_backpack_web"
if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "âŒ Container ${CONTAINER_NAME} nÃ£o estÃ¡ rodando."
    echo "Execute primeiro: bin/docker-up"
    exit 1
fi

# FunÃ§Ã£o de ajuda
show_help() {
    echo "ðŸ“‹ Uso: bin/docker-logs [OPÃ‡Ã•ES]"
    echo ""
    echo "OpÃ§Ãµes:"
    echo "  -f, --follow       Acompanhar logs em tempo real (padrÃ£o)"
    echo "  -n, --tail NUM     Mostrar apenas as Ãºltimas NUM linhas (padrÃ£o: 100)"
    echo "  --all              Mostrar todos os logs desde o inÃ­cio"
    echo "  --no-follow        Mostrar logs sem acompanhar em tempo real"
    echo "  -h, --help         Mostrar esta ajuda"
    echo ""
    echo "Exemplos:"
    echo "  bin/docker-logs                    # Ãšltimas 100 linhas + acompanhar"
    echo "  bin/docker-logs -n 50              # Ãšltimas 50 linhas + acompanhar"
    echo "  bin/docker-logs --all              # Todos os logs + acompanhar"
    echo "  bin/docker-logs --no-follow        # Ãšltimas 100 linhas sem acompanhar"
    echo ""
}

# Valores padrÃ£o
FOLLOW=true
TAIL="100"
SHOW_ALL=false

# Processar argumentos
while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--follow)
            FOLLOW=true
            shift
            ;;
        --no-follow)
            FOLLOW=false
            shift
            ;;
        -n|--tail)
            TAIL="$2"
            shift 2
            ;;
        --all)
            SHOW_ALL=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "âŒ OpÃ§Ã£o desconhecida: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
done

# Construir comando
CMD_ARGS=""

if [ "$SHOW_ALL" = true ]; then
    echo "ðŸ“œ Mostrando todos os logs do container ${CONTAINER_NAME}..."
else
    echo "ðŸ“œ Mostrando Ãºltimas ${TAIL} linhas dos logs do container ${CONTAINER_NAME}..."
    CMD_ARGS="--tail=${TAIL}"
fi

if [ "$FOLLOW" = true ]; then
    echo "ðŸ‘€ Acompanhando logs em tempo real... (Ctrl+C para sair)"
    CMD_ARGS="${CMD_ARGS} --follow"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Executar comando de logs
if docker compose version &> /dev/null; then
    docker compose logs ${CMD_ARGS} web
else
    docker-compose logs ${CMD_ARGS} web
fi

