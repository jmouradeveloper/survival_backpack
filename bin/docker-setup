#!/usr/bin/env bash
# Script para fazer o setup inicial do Docker

set -e

echo "üîß Configurando ambiente Docker para Survival Backpack..."

# Verificar se docker e docker-compose est√£o instalados
if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker n√£o est√° instalado. Por favor, instale o Docker primeiro."
    exit 1
fi

if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
    echo "‚ùå Docker Compose n√£o est√° instalado. Por favor, instale o Docker Compose primeiro."
    exit 1
fi

# Criar diret√≥rios necess√°rios se n√£o existirem
echo "üìÅ Criando diret√≥rios necess√°rios..."
mkdir -p storage log tmp

# Buildar a imagem
echo "üèóÔ∏è  Buildando a imagem Docker..."
if docker compose version &> /dev/null; then
    docker compose build
else
    docker-compose build
fi

# Subir os containers
echo "üöÄ Iniciando os containers..."
if docker compose version &> /dev/null; then
    docker compose up -d
else
    docker-compose up -d
fi

# Aguardar um momento para os containers iniciarem
echo "‚è≥ Aguardando containers iniciarem..."
sleep 5

# Preparar o banco de dados de desenvolvimento
echo "üóÑÔ∏è  Preparando banco de dados de desenvolvimento..."
if docker compose version &> /dev/null; then
    docker compose exec web bin/rails db:prepare
else
    docker-compose exec web bin/rails db:prepare
fi

# Preparar o banco de dados de testes
echo "üß™ Preparando banco de dados de testes..."
if docker compose version &> /dev/null; then
    docker compose exec web bin/rails db:create RAILS_ENV=test
    docker compose exec web bin/rails db:environment:set RAILS_ENV=test
    docker compose exec web bin/rails db:schema:load RAILS_ENV=test
else
    docker-compose exec web bin/rails db:create RAILS_ENV=test
    docker-compose exec web bin/rails db:environment:set RAILS_ENV=test
    docker-compose exec web bin/rails db:schema:load RAILS_ENV=test
fi

echo ""
echo "‚úÖ Setup conclu√≠do com sucesso!"
echo "üìç Acesse a aplica√ß√£o em: http://localhost:3000"
echo ""
echo "Comandos √∫teis:"
echo "  - Ver logs: bin/docker-logs"
echo "  - Executar testes: bin/docker-test"
echo "  - Console: bin/docker-console"
echo "  - Parar app: bin/docker-stop"
echo "  - Limpar tudo: bin/docker-clean"

