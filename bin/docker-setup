#!/usr/bin/env bash
# Script para fazer o setup inicial do Docker

set -e

echo "üîß Configurando ambiente Docker para Survival Backpack..."

# Verificar se docker est√° instalado
if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker n√£o est√° instalado. Por favor, instale o Docker primeiro."
    exit 1
fi

# Verificar se docker compose est√° dispon√≠vel
if ! docker compose version &> /dev/null; then
    echo "‚ùå Docker Compose n√£o est√° dispon√≠vel. Por favor, atualize o Docker para uma vers√£o que suporte 'docker compose'."
    exit 1
fi

# Criar diret√≥rios necess√°rios se n√£o existirem
echo "üìÅ Criando diret√≥rios necess√°rios..."
mkdir -p storage log tmp

# Buildar a imagem
echo "üèóÔ∏è  Buildando a imagem Docker..."
docker compose build

# Subir os containers
echo "üöÄ Iniciando os containers..."
docker compose up -d

# Aguardar um momento para os containers iniciarem
echo "‚è≥ Aguardando containers iniciarem..."
sleep 5

# Preparar o banco de dados de desenvolvimento
echo "üóÑÔ∏è  Preparando banco de dados de desenvolvimento..."
# Tentar preparar o banco, se falhar, resetar completamente
if ! docker compose exec web bin/rails db:prepare 2>/dev/null; then
    echo "‚ö†Ô∏è  Detectado problema com banco existente. Resetando banco de dados..."
    docker compose exec web bin/rails db:drop 2>/dev/null || true
    docker compose exec web bin/rails db:create
    docker compose exec web bin/rails db:migrate
fi

# Preparar o banco de dados de testes
echo "üß™ Preparando banco de dados de testes..."
# Remover arquivo f√≠sico do banco de teste para evitar conflitos de environment
docker compose exec web rm -f storage/test.sqlite3 storage/test.sqlite3-shm storage/test.sqlite3-wal
docker compose exec web bin/rails db:create RAILS_ENV=test
docker compose exec web bin/rails db:environment:set RAILS_ENV=test
docker compose exec web bin/rails db:migrate RAILS_ENV=test

echo ""
echo "‚úÖ Setup conclu√≠do com sucesso!"
echo "üìç Acesse a aplica√ß√£o em: http://localhost:3000"
echo ""
echo "Comandos √∫teis:"
echo "  - Ver logs: bin/docker-logs"
echo "  - Executar testes: bin/docker-test"
echo "  - Console: bin/docker-console"
echo "  - Parar app: bin/docker-stop"
echo "  - Limpar tudo: bin/docker-clean"

