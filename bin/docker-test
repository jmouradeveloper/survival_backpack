#!/usr/bin/env bash
# Script para executar testes automatizados no container Docker

set -e

# Verificar se docker estÃ¡ instalado
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker nÃ£o estÃ¡ instalado."
    exit 1
fi

# Verificar se o container estÃ¡ rodando
CONTAINER_NAME="survival_backpack_web"
CONTAINER_RUNNING=false

if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    CONTAINER_RUNNING=true
fi

# FunÃ§Ã£o de ajuda
show_help() {
    echo "ğŸ§ª Uso: bin/docker-test [OPÃ‡Ã•ES]"
    echo ""
    echo "OpÃ§Ãµes:"
    echo "  --all              Executar todos os testes (padrÃ£o)"
    echo "  --models           Executar apenas testes de models"
    echo "  --controllers      Executar apenas testes de controllers"
    echo "  --integration      Executar apenas testes de integraÃ§Ã£o"
    echo "  --system           Executar testes de sistema"
    echo "  --file PATH        Executar testes de um arquivo especÃ­fico"
    echo "  --coverage         Executar com relatÃ³rio de cobertura"
    echo "  --verbose          Modo verbose"
    echo "  -h, --help         Mostrar esta ajuda"
    echo ""
    echo "Exemplos:"
    echo "  bin/docker-test                           # Todos os testes"
    echo "  bin/docker-test --models                  # Apenas models"
    echo "  bin/docker-test --file test/models/food_item_test.rb"
    echo "  bin/docker-test --coverage                # Com cobertura"
    echo ""
}

# Valores padrÃ£o
TEST_CMD="bin/rails test"
VERBOSE=false
START_CONTAINER=false

# Processar argumentos
while [[ $# -gt 0 ]]; do
    case $1 in
        --all)
            TEST_CMD="bin/rails test"
            shift
            ;;
        --models)
            TEST_CMD="bin/rails test test/models/"
            shift
            ;;
        --controllers)
            TEST_CMD="bin/rails test test/controllers/"
            shift
            ;;
        --integration)
            TEST_CMD="bin/rails test test/integration/"
            shift
            ;;
        --system)
            TEST_CMD="bin/rails test:system"
            shift
            ;;
        --file)
            TEST_CMD="bin/rails test $2"
            shift 2
            ;;
        --coverage)
            TEST_CMD="COVERAGE=true bin/rails test"
            shift
            ;;
        --verbose)
            VERBOSE=true
            TEST_CMD="${TEST_CMD} --verbose"
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "âŒ OpÃ§Ã£o desconhecida: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
done

# Verificar/iniciar container se necessÃ¡rio
if [ "$CONTAINER_RUNNING" = false ]; then
    echo "âš ï¸  Container ${CONTAINER_NAME} nÃ£o estÃ¡ rodando."
    echo "ğŸš€ Iniciando container temporariamente..."
    
    docker compose up -d
    
    START_CONTAINER=true
    echo "â³ Aguardando container iniciar..."
    sleep 5
fi

# Preparar banco de dados de testes (garante que estÃ¡ atualizado)
echo "ğŸ—„ï¸  Sincronizando banco de dados de testes..."
# Aplicar migrations no ambiente de desenvolvimento (silencioso se jÃ¡ aplicadas)
docker compose exec web bin/rails db:migrate 2>&1 | grep -v "migrated" | grep -v "^$" || true

# Preparar banco de testes (recria e carrega schema limpo)
docker compose exec web bin/rails db:test:prepare 2>&1 | grep -v "^$" || true

echo "âœ… Banco de testes pronto!"
echo ""

echo "ğŸ§ª Executando testes..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Executar testes
EXIT_CODE=0
docker compose exec web ${TEST_CMD} || EXIT_CODE=$?

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Parar container se foi iniciado temporariamente
if [ "$START_CONTAINER" = true ]; then
    echo "ğŸ›‘ Parando container temporÃ¡rio..."
    docker compose stop
fi

# Exibir resultado
echo ""
if [ $EXIT_CODE -eq 0 ]; then
    echo "âœ… Todos os testes passaram!"
    echo ""
    echo "Comandos Ãºteis:"
    echo "  - Ver cobertura: bin/docker-test --coverage"
    echo "  - Testar models: bin/docker-test --models"
    echo "  - Modo verbose: bin/docker-test --verbose"
else
    echo "âŒ Alguns testes falharam!"
    echo ""
    echo "Dicas:"
    echo "  - Ver logs: bin/docker-logs"
    echo "  - Console Rails: bin/docker-console"
    echo "  - Executar teste especÃ­fico: bin/docker-test --file test/path/to/test.rb"
    exit $EXIT_CODE
fi

